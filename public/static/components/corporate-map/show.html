<div class="corporate-map widget">
  <script class="config" type="application/javascript">
      var initCorpMap = function() {
        var corpMapSettings = {
          "hoverColor": {{ widget.corporate_map.best_value.hover_color }},
          "selectedColor": {{ widget.corporate_map.best_value.primary_color }},
          "selectedRegions": {{ widget.corporate_map.best_value.populated_states }},
          "locationCounts": {{ widget.corporate_map.best_value.state_location_counts }},
          "corpSearchPage": "{{ widget.corp_search_page.value }}",
          "coreClientId": NaN
        }
        {{#if widget.core_client_id.value}}
          corpMapSettings.coreClientId = {{ widget.core_client_id.value }}
        {{/if}}

        var corpMapConfig = {
          "map": "usa_en",
          "borderColor": "#FFFFFF",
          "color": "#d6d6d6",
          "borderWidth": 2,
          "hoverColor": corpMapSettings.hoverColor,
          "selectedColor": corpMapSettings.selectedColor,
          "selectedRegions": corpMapSettings.selectedRegions,
          "locationCounts": corpMapSettings.locationCounts,
          "onRegionClick": function(element, code, region) {
            $(this).find('.selected').css('fill', corpMapSettings.selectedColor);
            var match = $.inArray(code.toUpperCase(), corpMapConfig.selectedRegions) > -1;
            if (match) {
              window.location.href = "/" + code.toLowerCase();
            }
          }
        };

        if (("ontouchstart" in window) || (navigator.MaxTouchPoints > 0) || (navigator.msMaxTouchPoints > 0)) {
          corpMapConfig.showTooltip = false;
        };

        var corpSearchPage = corpMapSettings.corpSearchPage.trim().length > 0;
        var coreClientId = !isNaN(corpMapSettings.coreClientId);

        if(coreClientId && corpSearchPage) {
          var apiUrl = "//www.g5api.com/api/v0/client_locations?client_id=" + corpMapSettings.coreClientId;
            $.ajax({
              url: apiUrl,
              dataType: 'json',
              success: function( data ) {
                corpMapConfig.selectedRegions = data.states.map(function(item){return item.name;});
                var hash = {};
                data.states.forEach(function(item){ 
                  hash[item.name] = item.location_count;
                });
                corpMapConfig.locationCounts = hash;
                corpMapConfig.onRegionClick = function(element, code, region) {
                  $(this).find('.selected').css('fill', corpMapSettings.selectedColor);
                  var match = $.inArray(code.toUpperCase(), corpMapConfig.selectedRegions) > -1;
                  if (match) {
                    window.location.href = "/" + corpMapSettings.corpSearchPage + "?state=" + code.toUpperCase();
                  };
                };
                $('.corporate-map').vectorMap(corpMapConfig);
              },
              error: function (a,b,c){
                console.log(JSON.stringify(a) + b + c)
              }
            });
        } else {
          $('.corporate-map').vectorMap(corpMapConfig);
        }
      };
  </script>

  <div id="corporate-map"></div>
</div>
